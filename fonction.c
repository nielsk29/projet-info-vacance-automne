#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <stdbool.h>
#include <math.h>

#include "fonction.h"
#include "variable.h"

// on utilise des floats pour faciliter les calculs et pour pouvoir etre entre deux positions
bool test_carre(float* pos){
    int carre_x = pos[0]/taille_carre; // position du carré
    int carre_y = pos[1]/taille_carre;
    if (map[carre_y*l_map[1]+carre_x] == '#'){
        return false;
    }else{
        return true;
    }
}
é&"''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''"
float rayon(float direction){
    float pos[2] ;
    pos[0] = pos_j[0];
    pos[1] = pos_j[1];
    while (test_carre(pos)){
        pos[0] = pos[0]+cosf(direction);
        pos[1] = pos[1]-sinf(direction);
        // printf("%f , %f\n",pos[0],pos[1]);
    }
    // printf("%f,%f\n",pos[0], pos[1]);
    return (sqrtf(powf((ceilf(pos[0])-pos_j[0]),2.0) + powf((ceilf(pos[1])-pos_j[1]),2.0)));
}
void image()
{
    float dif_dir = angle_regard / (float) nb_rayon; 
    int long_barre[nb_rayon];
    float i = regard_j-angle_regard/2;
    for(int t=0;t<nb_rayon;t=t+1){
        long_barre[t] = (int) roundf((35*taille_ecran)/(cosf(regard_j-i)*rayon(i)));
        // printf("%d : %f ; %d\n",t,i,long_barre[t]);
        i = i+dif_dir;
    }
    char* affichage=(char*)malloc(sizeof(char)*(taille_ecran*nb_rayon*300+1)) ; 
    affichage[0] = 0;
    for (int i = 0; i<taille_ecran; i++){
        for (int l=0; l<nb_rayon; l++){
            if (abs(i-taille_ecran/2)<long_barre[l]){
                strncat(affichage,"\033[31m#\033[00m",12);
                // printf("\033[31m#\033[00m");
            }
            else if (i>taille_ecran/2){
                strncat(affichage,"\033[37m%\033[00m",13);
                // printf("\033[37m%%\033[00m");
            }else{
                strncat(affichage,"\033[34m*\033[00m",12);
                //printf("\033[34m*\033[00");
            }
        }
        strncat(affichage,"\n",2);
    }

    printf("\033[0;0H");
    printf("%s\n",affichage);
    free(affichage);
}
